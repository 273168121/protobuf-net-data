<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildCommunityTasksPath>.</MSBuildCommunityTasksPath>
    <OutputDir>..\output</OutputDir>
    <NuspecFile>protobuf-net-data.nuspec</NuspecFile>
  </PropertyGroup>

  <Import Project="..\lib\MSBuild.Community.Tasks.v1.2.0.306\MSBuild.Community.Tasks.Targets"/>
  <UsingTask AssemblyFile="..\lib\NuGet.MSBuild.1.5.20831.132\NuGet.MSBuild.dll" TaskName="NuGet.MSBuild.NuGet" />

  <Target Name="CreateNupkg">
    <RemoveDir Directories="$(OutputDir)" />

    <!-- .NET 2.0 -->
    <MSBuild Projects="..\src\ProtoBuf.Data\ProtoBuf.Data.csproj"
             Targets="Clean; Rebuild"
             Properties="Configuration=Release;OutputPath=..\$(OutputDir)\lib\net20;TargetFrameworkVersion=v2.0" />

    <!-- .NET 3.0 -->
    <MSBuild Projects="..\src\ProtoBuf.Data\ProtoBuf.Data.csproj"
             Targets="Clean; Rebuild"
             Properties="Configuration=Release;OutputPath=..\$(OutputDir)\lib\net30;TargetFrameworkVersion=v3.0" />

    <!-- .NET 3.5 -->
    <MSBuild Projects="..\src\ProtoBuf.Data\ProtoBuf.Data.csproj"
             Targets="Clean; Rebuild"
             Properties="Configuration=Release;OutputPath=..\$(OutputDir)\lib\net35;TargetFrameworkVersion=v3.5" />

    <!-- .NET 4.0 -->
    <MSBuild Projects="..\src\ProtoBuf.Data\ProtoBuf.Data.csproj"
             Targets="Clean; Rebuild"
             Properties="Configuration=Release;OutputPath=..\$(OutputDir)\lib\net40;TargetFrameworkVersion=v4.0" />

    <!-- cleanup any files we won't be distributing in our nupkg -->
    <ItemGroup>
      <FilesToRemove Include="$(OutputDir)\**\protobuf-net.*" />
    </ItemGroup>
    <Delete Files="@(FilesToRemove)" />

    <GetAssemblyIdentity AssemblyFiles="$(OutputDir)\lib\net20\protobuf-net-data.dll">
      <Output TaskParameter="Assemblies" ItemName="AssemblyInfo"/>
    </GetAssemblyIdentity>

    <Copy SourceFiles="$(NuspecFile)" DestinationFolder="$(OutputDir)" />

    <XmlUpdate XmlFileName="$(OutputDir)\$(NuspecFile)"
               Xpath="//version"
               Value="%(AssemblyInfo.Version)" />

    <NuGet BaseDir="$(OutputDir)" 
           PackageDir="$(OutputDir)" 
           SpecFile="$(OutputDir)\$(NuspecFile)" />
    
  </Target>
</Project>